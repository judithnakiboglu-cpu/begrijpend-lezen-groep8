<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Begrijpend Lezen ‚Äì Groep 8</title>
  <style>
    :root{ --blue:#2e5bff; --bg:#f6f7fb; --card:#fff; --muted:#5a6079; --border:#e6e8f2; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui, Arial; margin:0; background:var(--bg); }
    .wrap{ max-width:1040px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border-radius:16px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.08); margin-bottom:12px; }
    .topbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    h1{ font-size:24px; margin:0; font-weight:900; }
    h2{ font-size:26px; margin:10px 0 12px; font-weight:900; }
    .muted{ color:var(--muted); }
    .small{ font-size:12px; }
    .tabs{ display:flex; gap:8px; }
    button{ border:0; border-radius:12px; padding:10px 12px; cursor:pointer; }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .tab{ background:#e9ecf8; }
    .tab.active{ background:var(--blue); color:white; }
    .primary{ background:var(--blue); color:white; }
    .ghost{ background:#eef2ff; }
    .danger{ background:#ff3b30; color:white; }
    input, textarea, select{ width:100%; padding:10px; border-radius:12px; border:1px solid #d9dbe7; }
    textarea{ min-height:120px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:240px; }
    .pill{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; background:#eef2ff; }
    .q{ padding:12px; border-radius:12px; border:1px solid #eee; margin:10px 0; }
    .opt{ display:block; padding:10px 12px; border-radius:12px; border:1px solid var(--border); margin:10px 0; cursor:pointer; }
    .opt:hover{ background:#f3f5ff; }
    .opt.disabled{ opacity:.9; cursor:default; }
    .feedback{ margin-top:10px; padding:12px; border-radius:12px; }
    .good{ background:#e9fbef; border:1px solid #b7ebc7; }
    .bad{ background:#fff0f0; border:1px solid #ffcccc; }
    .ok{ color:#137333; font-weight:900; }
    .no{ color:#b00020; font-weight:900; }
    .hr{ border:none; border-top:1px solid #eee; margin:14px 0; }
    .listItem{ border:1px solid #eee; border-radius:12px; padding:10px; margin:8px 0; }
    .two{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#f1f3ff; padding:2px 6px; border-radius:8px; }

    /* Reading text formatting */
    #kidText{
      margin: 0;
      font-size: 17px;
      line-height: 1.75;
      letter-spacing: 0.1px;
      color:#111;
    }
    #kidText p{ margin:0 0 14px 0; }
    #kidText .title{
      font-size:22px;
      font-weight:900;
      margin:18px 0 10px 0;
      letter-spacing:.2px;
    }
    #kidText ul, #kidText ol{ margin:0 0 14px 22px; padding:0; }
    #kidText li{ margin:6px 0; }
    .imgWrap{ text-align:center; margin:18px 0; }
    .imgWrap img{ max-width:100%; max-height:360px; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.15); }

    /* Text + image side-by-side */
    .textLayout{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:16px;
      align-items:start;
    }
    .sideMedia img{
      width:100%;
      max-height:420px;
      object-fit:contain;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.12);
      background:white;
    }
    @media (max-width: 850px){
      .textLayout{ grid-template-columns: 1fr; }
    }

    /* Quiz flow */
    .progress{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .bigSticker{
      display:flex; align-items:center; justify-content:center;
      font-size:120px; line-height:1;
      padding:20px 24px; border-radius:22px;
      background:linear-gradient(145deg,#fff8d6,#ffeaa0);
      border:2px solid #f6c945;
      width:fit-content;
      margin:12px auto;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.25));
      animation:stickerPop .45s ease;
    }
    @keyframes stickerPop{
      0%{ transform:scale(.3) rotate(-12deg); opacity:0; }
      60%{ transform:scale(1.15) rotate(6deg); opacity:1; }
      100%{ transform:scale(1); }
    }
    .center{ text-align:center; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid #eee; padding:10px; text-align:left; font-size:13px; }
    th{ font-size:12px; color:var(--muted); font-weight:800; }
    details{ border:1px solid #eee; border-radius:12px; padding:10px; margin:10px 0; }
    summary{ cursor:pointer; font-weight:800; }

    /* Optional: click image to zoom */
    .zoomOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:9999;
    }
    .zoomOverlay img{ max-width:100%; max-height:100%; border-radius:14px; background:white; }

    /* Parent question editor tweaks */
    #qText{ min-height:90px; }
    .tag{ display:inline-block; padding:2px 8px; border-radius:999px; background:#f1f3ff; font-size:12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <h1>Begrijpend Lezen ‚Äì Groep 8</h1>
          <div class="muted small">Leerling oefent ‚úÖ‚ùå ‚Äî Ouder maakt teksten & vragen ‚Äî Resultaten worden lokaal opgeslagen.</div>
        </div>
        <div class="tabs">
          <button class="tab active" id="tabKid" type="button">Leerling</button>
          <button class="tab" id="tabParent" type="button">Ouder</button>
        </div>
      </div>
    </div>

    <!-- LEERLING -->
    <div id="kidView">
      <div class="card">
        <div class="row">
          <div>
            <div class="pill">Tekst kiezen</div>
            <select id="lessonSelect"></select>
            <div class="muted small" style="margin-top:6px;">
              Tip: klik <span class="kbd">Start</span> om te beginnen.
            </div>
          </div>
          <div class="topbar" style="justify-content:flex-end;">
            <div class="pill">Voortgang: <span id="progNow">0</span>/<span id="progTotal">0</span></div>
            <button class="ghost" id="restartQuiz" type="button">Opnieuw</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="pill">Tekst</div>
        <h2 id="kidTitle">‚Äî</h2>

        <div class="textLayout">
          <div id="kidText"></div>

          <div id="kidSideMedia" class="sideMedia" style="display:none;">
            <img id="kidImg" alt="Afbeelding" loading="lazy">
            <div id="kidImgCaption" class="muted small" style="margin-top:6px; display:none;"></div>
          </div>
        </div>
      </div>

      <div class="card" id="quizCard">
        <div class="progress">
          <div>
            <div class="pill">Vraag</div>
            <div class="muted small" id="kidHint">Je kunt per vraag maar 1x kiezen.</div>
          </div>
          <div class="topbar" style="justify-content:flex-end;">
            <div class="pill">Score: <span id="scoreNow">0</span>/<span id="scoreTotal">0</span></div>
            <button class="primary" id="startBtn" type="button">Start</button>
            <button class="primary" id="submitBtn" type="button" style="display:none;">Controleer</button>
            <button class="primary" id="nextBtn" type="button" style="display:none;">Volgende</button>
          </div>
        </div>
        <div id="oneQuestion"></div>
        <div id="endScreen" style="display:none;"></div>
      </div>
    </div>

    <!-- OUDER -->
    <div id="parentView" style="display:none;">
      <div class="card" id="parentLockCard">
        <div class="pill">Ouder-modus beveiligen (optioneel)</div>
        <div class="muted small" style="margin:8px 0 12px;">
          Stel een pincode in zodat je kind niet per ongeluk teksten/vraagjes wijzigt.
        </div>
        <div class="row">
          <div>
            <label class="muted small">Pincode (4‚Äì8 cijfers, optioneel)</label>
            <input id="pinSet" inputmode="numeric" placeholder="Bijv. 1234" maxlength="8">
          </div>
          <div>
            <label class="muted small">Pincode invoeren</label>
            <input id="pinEnter" inputmode="numeric" placeholder="(als je pin hebt ingesteld)">
          </div>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="primary" id="savePin" type="button">Pincode opslaan</button>
          <button class="ghost" id="unlock" type="button">Ouder-modus openen</button>
        </div>
        <div class="muted small" id="pinMsg" style="margin-top:8px;"></div>
      </div>

      <div class="card" id="parentEditor" style="display:none;">
        <div class="topbar">
          <div>
            <div class="pill">Teksten & vragen</div>
            <div class="muted small">Meerkeuze (1 goed) √©n Multiple choice (meerdere goede).</div>
          </div>
          <div class="row" style="margin:0;">
            <button class="primary" id="addLesson" type="button">Nieuwe tekst</button>
            <button class="ghost" id="exportData" type="button">Export teksten</button>
            <button class="ghost" id="importData" type="button">Import teksten</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div>
            <label class="muted small">Kies tekst</label>
            <select id="parentLessonSelect"></select>
          </div>
          <div>
            <label class="muted small">Tekst verwijderen</label>
            <button class="danger" id="deleteLesson" type="button">Verwijder deze tekst</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="pill">Tekst bewerken</div>
        <div class="row" style="margin-top:8px;">
          <div>
            <label class="muted small">Titel</label>
            <input id="editTitle" placeholder="Bijv. Industri√´le revolutie">
          </div>
        </div>

        <label class="muted small">Tekst (kopjes op eigen regel + lege regel erna)</label>
        <textarea id="editText" placeholder="Plak hier de tekst..."></textarea>

        <div class="row" style="margin-top:10px;">
          <div>
            <label class="muted small">Afbeelding URL (optioneel)</label>
            <input id="editImgUrl" placeholder="https://...jpg / .png">
          </div>
          <div>
            <label class="muted small">Bijschrift (optioneel)</label>
            <input id="editImgCaption" placeholder="Bijv. Stoommachine van James Watt">
          </div>
        </div>

        <div class="muted small" style="margin-top:6px;">
          In de tekst kan ook een afbeelding op eigen regel:<br>
          <span class="kbd">[img]https://...jpg[/img]</span><br>
          En een lijst (bullet points) zo:<br>
          <span class="kbd">- Zelda (avontuur)</span><br>
          <span class="kbd">- Street Fighter (vechten)</span>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="primary" id="saveLesson" type="button">Opslaan</button>
        </div>

        <div class="hr"></div>

        <div class="pill">Vraag toevoegen / bewerken</div>

        <div class="row" style="margin-top:8px;">
          <div>
            <label class="muted small">Type vraag</label>
            <select id="qType">
              <option value="single">Meerkeuze (1 goed antwoord)</option>
              <option value="multi">Multiple choice (meerdere goede antwoorden)</option>
            </select>
          </div>
          <div>
            <label class="muted small">Tip</label>
            <div class="muted small" style="padding:10px 12px; border:1px solid #eee; border-radius:12px;">
              <span class="tag">single</span> leerling kiest 1 optie (direct lock) ‚Ä¢
              <span class="tag">multi</span> leerling kiest meerdere (dan ‚ÄúControleer‚Äù)
            </div>
          </div>
        </div>

        <div class="row">
          <div>
            <label class="muted small">Vraag (mag meerdere regels)</label>
            <textarea id="qText" placeholder="Bijv. Noem 2 dingen die door de stoommachine mogelijk werden."></textarea>
          </div>
        </div>

        <div class="row">
          <div><label class="muted small">A</label><input id="a0" placeholder="Antwoord A"></div>
          <div><label class="muted small">B</label><input id="a1" placeholder="Antwoord B"></div>
        </div>
        <div class="row">
          <div><label class="muted small">C</label><input id="a2" placeholder="Antwoord C"></div>
          <div><label class="muted small">D</label><input id="a3" placeholder="Antwoord D"></div>
        </div>

        <div class="row" id="singleCorrectRow">
          <div>
            <label class="muted small">Juiste antwoord (single)</label>
            <select id="correctSingle">
              <option value="0">A</option><option value="1">B</option>
              <option value="2">C</option><option value="3">D</option>
            </select>
          </div>
          <div>
            <label class="muted small">Uitleg/feedback (optioneel)</label>
            <input id="explain" placeholder="Bijv. In alinea 2 staat...">
          </div>
        </div>

        <div class="row" id="multiCorrectRow" style="display:none;">
          <div>
            <label class="muted small">Juiste antwoorden (multi)</label>
            <div class="row" style="gap:8px; margin-top:6px;">
              <label class="pill" style="cursor:pointer;"><input type="checkbox" id="m0" style="margin-right:6px;">A</label>
              <label class="pill" style="cursor:pointer;"><input type="checkbox" id="m1" style="margin-right:6px;">B</label>
              <label class="pill" style="cursor:pointer;"><input type="checkbox" id="m2" style="margin-right:6px;">C</label>
              <label class="pill" style="cursor:pointer;"><input type="checkbox" id="m3" style="margin-right:6px;">D</label>
            </div>
          </div>
          <div>
            <label class="muted small">Uitleg/feedback (optioneel)</label>
            <input id="explain2" placeholder="Bijv. In alinea 3 staat...">
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="primary" id="addQuestion" type="button">Vraag toevoegen</button>
          <button class="ghost" id="cancelEdit" type="button" style="display:none;">Annuleer bewerken</button>
        </div>

        <div class="hr"></div>

        <div class="pill">Vragenlijst</div>
        <div class="muted small">Bewerk ‚Ä¢ Verwijder ‚Ä¢ Omhoog/omlaag (volgorde).</div>
        <div id="questionList"></div>

        <div class="hr"></div>

        <div class="topbar">
          <div>
            <div class="pill">Resultaten (overzicht)</div>
            <div class="muted small">Pogingen: welke tekst, score, datum/tijd + details per vraag.</div>
          </div>
          <div class="row" style="margin:0;">
            <button class="ghost" id="exportHistory" type="button">Export resultaten</button>
            <button class="danger" id="clearHistory" type="button">Wis resultaten</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label class="muted small">Filter op tekst</label>
            <select id="historyLessonFilter"></select>
          </div>
          <div>
            <label class="muted small">Laatste pogingen</label>
            <input id="historyLimit" inputmode="numeric" value="50">
          </div>
        </div>

        <div id="historyTableWrap" style="margin-top:10px;"></div>
        <div id="historyDetailsWrap" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <div class="zoomOverlay" id="zoomOverlay" title="Klik om te sluiten">
    <img id="zoomImg" alt="Zoom">
  </div>

<script>
  // ===== Storage keys (KEEP THESE to not lose existing content) =====
  const KEY = "bl_multi_lessons_v2";
  const PIN_KEY = "bl_parent_pin_v1";
  const HISTORY_KEY = "bl_attempt_history_v1";

  // ===== Helpers =====
  function cryptoRandomId(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }
  function clone(obj){
    // structuredClone fallback (important for older browsers)
    try{ return structuredClone(obj); } catch { return JSON.parse(JSON.stringify(obj)); }
  }
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function idxToLetter(i){ return ["A","B","C","D"][i] ?? "?"; }
  function normalizeIndices(arr){
    const set = new Set((arr||[]).map(n=>Number(n)).filter(n=>Number.isFinite(n) && n>=0 && n<=3));
    return Array.from(set).sort((a,b)=>a-b);
  }
  function equalSet(a,b){
    a = normalizeIndices(a); b = normalizeIndices(b);
    if(a.length !== b.length) return false;
    for(let i=0;i<a.length;i++) if(a[i]!==b[i]) return false;
    return true;
  }

  // ===== Default DB =====
  const defaultDB = {
    lessons: [
      {
        id: cryptoRandomId(),
        title: "Voorbeeld: De ijsjeswedstrijd",
        text:
`Saar en Amin doen mee aan een ijsjeswedstrijd. Ze moeten in tien minuten zoveel mogelijk ijsjes verkopen.
Amin is snel met rekenen, maar praat zacht. Saar praat heel overtuigend, maar moet soms langer nadenken over geld teruggeven.

- Saar glimlacht en maakt een praatje.
- Amin leert harder praten.

[img]https://upload.wikimedia.org/wikipedia/commons/thumb/7/7e/Ice_cream_cone.jpg/640px-Ice_cream_cone.jpg[/img]

Stoommachines

Dit is een voorbeeld van een kopje. Zet kopjes op een eigen regel en laat daarna een lege regel.`,
        imageUrl: "",
        imageCaption: "",
        questions: [
          {
            type: "single",
            text: "Waarom verkocht Saar in het begin meer ijsjes?",
            options: [
              "Omdat ze sneller kon rekenen",
              "Omdat ze overtuigend praatte en glimlachte",
              "Omdat ze goedkoper was",
              "Omdat Amin niet wilde verkopen"
            ],
            correctIndex: 1,
            explanation: "In alinea 2 staat dat Saar glimlacht en een praatje maakt; dat helpt bij verkopen."
          },
          {
            type: "multi",
            text: "Welke 2 dingen helpt Amin later ook te doen? (kies 2)",
            options: [
              "Harder praten",
              "Glimlachen / praatje maken",
              "De prijs verhogen",
              "Stoppen met verkopen"
            ],
            correctIndices: [0,1],
            explanation: "In alinea 3 staat dat Amin harder praat en een grapje maakt (zoals Saar: sociaal doen)."
          }
        ]
      }
    ]
  };

  function loadDB(){
    try{
      const raw = localStorage.getItem(KEY);
      if(!raw) return clone(defaultDB);
      const db = JSON.parse(raw);
      if(!db || !Array.isArray(db.lessons) || db.lessons.length===0) return clone(defaultDB);

      db.lessons.forEach(l=>{
        l.id = l.id || cryptoRandomId();
        l.title = l.title || "Zonder titel";
        l.text = l.text || "";
        l.imageUrl = l.imageUrl || "";
        l.imageCaption = l.imageCaption || "";
        l.questions = Array.isArray(l.questions) ? l.questions : [];

        // Normalize questions to support BOTH old and new formats
        l.questions.forEach(q=>{
          q.type = q.type === "multi" ? "multi" : "single";
          q.text = q.text || "";
          q.options = Array.isArray(q.options) ? q.options : ["","","",""];
          q.options = [q.options[0]||"", q.options[1]||"", q.options[2]||"", q.options[3]||""];

          if(q.type === "single"){
            // old format: correctIndex
            if(q.correctIndex === undefined && Array.isArray(q.correctIndices) && q.correctIndices.length){
              q.correctIndex = Number(q.correctIndices[0]) || 0;
            }
            q.correctIndex = Number.isFinite(Number(q.correctIndex)) ? Number(q.correctIndex) : 0;
            q.explanation = q.explanation ?? q.explain ?? "";
          }else{
            // multi format: correctIndices array
            if(!Array.isArray(q.correctIndices)){
              if(Number.isFinite(Number(q.correctIndex))) q.correctIndices = [Number(q.correctIndex)];
              else q.correctIndices = [];
            }
            q.correctIndices = normalizeIndices(q.correctIndices);
            q.explanation = q.explanation ?? q.explain ?? "";
          }
        });
      });

      return db;
    }catch{
      return clone(defaultDB);
    }
  }
  function saveDB(){ localStorage.setItem(KEY, JSON.stringify(DB)); }

  function loadHistory(){
    try{
      const raw = localStorage.getItem(HISTORY_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }

  // ===== Pretty reading formatter (plain text -> HTML) =====
  function formatReadingText(txt){
    if(!txt) return "";
    txt = txt.replace(/\r/g, "");

    const lines = txt.split("\n");
    let html = "";
    let para = [];
    let listType = null; // "ul" | "ol"
    let listItems = [];

    function flushPara(){
      const block = para.join("\n").trim();
      para = [];
      if(!block) return;

      // If single short line without punctuation -> treat as title
      const only = block.split("\n").map(s=>s.trim()).filter(Boolean);
      if(only.length === 1){
        const line = only[0];
        const looksLikeTitle = line.length <= 60 && !/[.,;:]$/.test(line);
        if(looksLikeTitle){
          html += `<div class="title">${escapeHtml(line)}</div>`;
          return;
        }
      }

      // support [img]...[/img] inside paragraph lines
      const rendered = only.map(l=>{
        const t = l.trim();
        if(t.startsWith("[img]") && t.endsWith("[/img]")){
          const url = t.slice(5,-6).trim();
          const safeUrl = escapeHtml(url);
          return `<div class="imgWrap"><img src="${safeUrl}" loading="lazy" alt="Afbeelding"></div>`;
        }
        return escapeHtml(l);
      }).join("<br>");

      html += `<p>${rendered}</p>`;
    }

    function flushList(){
      if(!listType || listItems.length === 0) { listType=null; listItems=[]; return; }
      const tag = listType === "ol" ? "ol" : "ul";
      html += `<${tag}>` + listItems.map(li=>`<li>${escapeHtml(li)}</li>`).join("") + `</${tag}>`;
      listType = null; listItems = [];
    }

    for(const rawLine of lines){
      const line = rawLine.replace(/\s+$/,"");
      const trimmed = line.trim();

      // blank line: close current structures
      if(!trimmed){
        flushPara();
        flushList();
        continue;
      }

      // list detection: "- " or "* " bullets, or "1. " ordered list
      const mUl = trimmed.match(/^[-*]\s+(.*)$/);
      const mOl = trimmed.match(/^\d+\.\s+(.*)$/);

      if(mUl){
        flushPara();
        if(listType && listType !== "ul") flushList();
        listType = "ul";
        listItems.push(mUl[1]);
        continue;
      }
      if(mOl){
        flushPara();
        if(listType && listType !== "ol") flushList();
        listType = "ol";
        listItems.push(mOl[1]);
        continue;
      }

      // normal line
      flushList();
      para.push(line);
    }

    flushPara();
    flushList();
    return html;
  }

  // ===== Stickers (global, changes each finish) =====
  const STICKERS = [
    { emoji:"üèÜ", label:"Kampioen" },
    { emoji:"ü¶ä", label:"Slimme vos" },
    { emoji:"üöÄ", label:"Raketsnel" },
    { emoji:"ü¶Ñ", label:"Magisch goed" },
    { emoji:"ü¶â", label:"Wijze uil" },
    { emoji:"üåà", label:"Top gedaan!" },
    { emoji:"üêº", label:"Super!" },
    { emoji:"üéØ", label:"Perfect!" },
    { emoji:"üß†", label:"Breinbaas" },
    { emoji:"üåü", label:"Ster!" }
  ];
  function pickRandomSticker(){
    return STICKERS[Math.floor(Math.random() * STICKERS.length)];
  }

  // ===== App state =====
  let DB = loadDB();
  let currentLessonId = DB.lessons[0]?.id || cryptoRandomId();

  // quiz state
  let quiz = {
    started: false,
    qIndex: 0,
    locked: false,
    answers: [],          // per question: number (single) or array<number> (multi)
    correctCount: 0
  };

  // parent edit state
  let editingQuestionIndex = null;

  // ===== Tabs =====
  const tabKid = document.getElementById("tabKid");
  const tabParent = document.getElementById("tabParent");
  const kidView = document.getElementById("kidView");
  const parentView = document.getElementById("parentView");

  tabKid.onclick = ()=> setMode("kid");
  tabParent.onclick = ()=> setMode("parent");

  function setMode(mode){
    if(mode==="kid"){
      tabKid.classList.add("active");
      tabParent.classList.remove("active");
      kidView.style.display = "";
      parentView.style.display = "none";
      renderKid();
    }else{
      tabParent.classList.add("active");
      tabKid.classList.remove("active");
      kidView.style.display = "none";
      parentView.style.display = "";
      setupParentLock();
      renderParent();
    }
  }

  function getLessonById(id){
    return DB.lessons.find(l=>l.id===id) || DB.lessons[0];
  }

  // ===== Kid UI elements =====
  const lessonSelect = document.getElementById("lessonSelect");
  const kidTitle = document.getElementById("kidTitle");
  const kidText = document.getElementById("kidText");
  const progNow = document.getElementById("progNow");
  const progTotal = document.getElementById("progTotal");
  const scoreNow = document.getElementById("scoreNow");
  const scoreTotal = document.getElementById("scoreTotal");
  const startBtn = document.getElementById("startBtn");
  const submitBtn = document.getElementById("submitBtn");
  const nextBtn = document.getElementById("nextBtn");
  const oneQuestion = document.getElementById("oneQuestion");
  const endScreen = document.getElementById("endScreen");
  const kidHint = document.getElementById("kidHint");

  // side image
  const kidSideMedia = document.getElementById("kidSideMedia");
  const kidImg = document.getElementById("kidImg");
  const kidImgCaption = document.getElementById("kidImgCaption");

  function renderLessonDropdown(selectEl){
    selectEl.innerHTML = "";
    DB.lessons.forEach(l=>{
      const opt = document.createElement("option");
      opt.value = l.id;
      opt.textContent = l.title;
      selectEl.appendChild(opt);
    });
    selectEl.value = currentLessonId;
  }

  lessonSelect.onchange = (e)=>{
    currentLessonId = e.target.value;
    resetQuiz();
    renderKid();
  };

  document.getElementById("restartQuiz").onclick = ()=>{
    resetQuiz();
    renderKid();
  };

  startBtn.onclick = ()=>{
    const lesson = getLessonById(currentLessonId);
    if(!lesson || lesson.questions.length === 0){
      alert("Er staan nog geen vragen in deze tekst.");
      return;
    }
    quiz.started = true;
    quiz.qIndex = 0;
    quiz.locked = false;
    quiz.answers = Array(lesson.questions.length).fill(null);
    quiz.correctCount = 0;
    renderKid();
  };

  submitBtn.onclick = ()=>{
    // only used for multi questions
    const lesson = getLessonById(currentLessonId);
    if(!quiz.started) return;
    const q = lesson.questions[quiz.qIndex];
    if(q.type !== "multi") return;
    submitMultiAnswer(lesson);
  };

  nextBtn.onclick = ()=>{
    const lesson = getLessonById(currentLessonId);
    if(!quiz.started) return;

    if(quiz.qIndex < lesson.questions.length - 1){
      quiz.qIndex++;
      quiz.locked = false;
      renderKid();
    }else{
      finishQuiz();
    }
  };

  function resetQuiz(){
    quiz.started = false;
    quiz.qIndex = 0;
    quiz.locked = false;
    quiz.answers = [];
    quiz.correctCount = 0;
    startBtn.style.display = "";
    submitBtn.style.display = "none";
    nextBtn.style.display = "none";
    endScreen.style.display = "none";
  }

  function setSideImage(lesson){
    const url = (lesson.imageUrl || "").trim();
    const cap = (lesson.imageCaption || "").trim();

    if(url){
      kidImg.src = url;
      kidSideMedia.style.display = "";
      if(cap){
        kidImgCaption.textContent = cap;
        kidImgCaption.style.display = "";
      }else{
        kidImgCaption.style.display = "none";
      }
    }else{
      kidSideMedia.style.display = "none";
      kidImg.removeAttribute("src");
      kidImgCaption.style.display = "none";
    }
  }

  function renderKid(){
    if(!DB.lessons || DB.lessons.length === 0){
      DB = clone(defaultDB);
      saveDB();
    }

    renderLessonDropdown(lessonSelect);
    const lesson = getLessonById(currentLessonId);
    currentLessonId = lesson.id;

    kidTitle.textContent = lesson.title || "‚Äî";
    kidText.innerHTML = formatReadingText(lesson.text || "");
    setSideImage(lesson);

    progTotal.textContent = lesson.questions.length;
    scoreTotal.textContent = lesson.questions.length;

    scoreNow.textContent = quiz.correctCount;
    progNow.textContent = quiz.started ? (lesson.questions.length ? (quiz.qIndex + 1) : 0) : 0;

    if(!quiz.started){
      startBtn.style.display = "";
      submitBtn.style.display = "none";
      nextBtn.style.display = "none";
      oneQuestion.innerHTML = `<div class="muted">Klik <strong>Start</strong> om te beginnen.</div>`;
      endScreen.style.display = "none";
      kidHint.textContent = "Je kunt per vraag maar 1x kiezen.";
    }else{
      startBtn.style.display = "none";
      endScreen.style.display = "none";
      renderOneQuestion(lesson);
    }
  }

  function renderOneQuestion(lesson){
    const total = lesson.questions.length;
    if(total === 0){
      oneQuestion.innerHTML = `<div class="muted">Geen vragen in deze tekst.</div>`;
      submitBtn.style.display = "none";
      nextBtn.style.display = "none";
      return;
    }

    const q = lesson.questions[quiz.qIndex];
    const chosen = quiz.answers[quiz.qIndex];

    kidHint.textContent = q.type === "multi"
      ? "Multiple choice: je mag meerdere opties aankruisen, daarna ‚ÄòControleer‚Äô."
      : "Meerkeuze: je kiest 1 optie (daarna kun je niet meer veranderen).";

    oneQuestion.innerHTML = "";
    const box = document.createElement("div");
    box.className = "q";

    const title = document.createElement("div");
    title.innerHTML = `<strong>Vraag ${quiz.qIndex+1}.</strong> ${escapeHtml(q.text || "").replaceAll("\n","<br>")}`;
    box.appendChild(title);

    const fb = document.createElement("div");
    fb.id = "fb";
    box.appendChild(fb);

    // SINGLE (radio) = lock immediately on click (like before)
    if(q.type !== "multi"){
      (q.options || []).forEach((opt, oi)=>{
        const lab = document.createElement("label");
        lab.className = "opt" + (quiz.locked ? " disabled" : "");

        const r = document.createElement("input");
        r.type = "radio";
        r.name = "q" + quiz.qIndex;
        r.value = oi;
        r.style.marginRight = "10px";
        r.disabled = quiz.locked;
        if(chosen === oi) r.checked = true;

        lab.appendChild(r);
        lab.appendChild(document.createTextNode(opt || ""));

        if(!quiz.locked){
          lab.onclick = (ev)=>{
            ev.preventDefault();
            lockSingleAnswer(lesson, oi);
          };
        }

        box.insertBefore(lab, fb);
      });

      oneQuestion.appendChild(box);

      if(chosen !== null && chosen !== undefined){
        showLockedFeedback(q, chosen);
        quiz.locked = true;
        submitBtn.style.display = "none";
        nextBtn.style.display = "";
        nextBtn.textContent = (quiz.qIndex === total - 1) ? "Resultaat" : "Volgende";
      }else{
        submitBtn.style.display = "none";
        nextBtn.style.display = "none";
      }
      return;
    }

    // MULTI (checkbox) = allow select many, then "Controleer"
    const picked = Array.isArray(chosen) ? chosen.slice() : [];
    const tempPicked = new Set(picked);

    (q.options || []).forEach((opt, oi)=>{
      const lab = document.createElement("label");
      lab.className = "opt" + (quiz.locked ? " disabled" : "");

      const c = document.createElement("input");
      c.type = "checkbox";
      c.value = oi;
      c.style.marginRight = "10px";
      c.disabled = quiz.locked;
      c.checked = tempPicked.has(oi);

      c.onchange = ()=>{
        if(c.checked) tempPicked.add(oi);
        else tempPicked.delete(oi);
        // store as the user ticks (still not locked until submit)
        quiz.answers[quiz.qIndex] = Array.from(tempPicked).sort((a,b)=>a-b);
      };

      lab.appendChild(c);
      lab.appendChild(document.createTextNode(opt || ""));
      box.insertBefore(lab, fb);
    });

    oneQuestion.appendChild(box);

    if(quiz.locked){
      // already submitted/locked
      showLockedFeedbackMulti(q, picked);
      submitBtn.style.display = "none";
      nextBtn.style.display = "";
      nextBtn.textContent = (quiz.qIndex === total - 1) ? "Resultaat" : "Volgende";
    }else{
      // not locked yet
      submitBtn.style.display = "";
      nextBtn.style.display = "none";
      // if no selection yet, keep empty array stored so it doesn't crash
      if(quiz.answers[quiz.qIndex] == null) quiz.answers[quiz.qIndex] = [];
    }
  }

  function lockSingleAnswer(lesson, chosenIndex){
    const q = lesson.questions[quiz.qIndex];
    if(quiz.answers[quiz.qIndex] !== null && quiz.answers[quiz.qIndex] !== undefined) return;

    quiz.answers[quiz.qIndex] = chosenIndex;
    quiz.locked = true;

    if(chosenIndex === q.correctIndex) quiz.correctCount++;
    scoreNow.textContent = quiz.correctCount;

    showLockedFeedback(q, chosenIndex);

    submitBtn.style.display = "none";
    nextBtn.style.display = "";
    nextBtn.textContent = (quiz.qIndex === lesson.questions.length - 1) ? "Resultaat" : "Volgende";

    setTimeout(()=> renderKid(), 50);
  }

  function submitMultiAnswer(lesson){
    const q = lesson.questions[quiz.qIndex];
    if(q.type !== "multi") return;

    const chosenArr = normalizeIndices(quiz.answers[quiz.qIndex] || []);
    // lock only once
    if(quiz.locked) return;

    quiz.answers[quiz.qIndex] = chosenArr;
    quiz.locked = true;

    const isCorrect = equalSet(chosenArr, q.correctIndices || []);
    if(isCorrect) quiz.correctCount++;
    scoreNow.textContent = quiz.correctCount;

    showLockedFeedbackMulti(q, chosenArr);

    submitBtn.style.display = "none";
    nextBtn.style.display = "";
    nextBtn.textContent = (quiz.qIndex === lesson.questions.length - 1) ? "Resultaat" : "Volgende";

    setTimeout(()=> renderKid(), 50);
  }

  function showLockedFeedback(q, chosenIndex){
    const fb = document.getElementById("fb");
    const good = chosenIndex === q.correctIndex;
    const explain = q.explanation ? `<div class="muted small" style="margin-top:8px;">${escapeHtml(q.explanation)}</div>` : "";

    fb.className = "feedback " + (good ? "good" : "bad");
    fb.innerHTML = good
      ? `<span class="ok">‚úÖ Goed!</span>${explain}`
      : `<span class="no">‚ùå Fout.</span> <span class="muted small">Juiste antwoord: ${idxToLetter(q.correctIndex)}</span>${explain}`;
  }

  function showLockedFeedbackMulti(q, chosenArr){
    const fb = document.getElementById("fb");
    const correctArr = normalizeIndices(q.correctIndices || []);
    const good = equalSet(chosenArr, correctArr);

    const chosenTxt = chosenArr.length ? chosenArr.map(idxToLetter).join(", ") : "-";
    const corrTxt = correctArr.length ? correctArr.map(idxToLetter).join(", ") : "-";
    const explain = q.explanation ? `<div class="muted small" style="margin-top:8px;">${escapeHtml(q.explanation)}</div>` : "";

    fb.className = "feedback " + (good ? "good" : "bad");
    fb.innerHTML = good
      ? `<span class="ok">‚úÖ Goed!</span> <span class="muted small">(${chosenTxt})</span>${explain}`
      : `<span class="no">‚ùå Niet helemaal.</span>
         <div class="muted small" style="margin-top:6px;">Jij koos: <strong>${escapeHtml(chosenTxt)}</strong> ‚Ä¢ Juiste: <strong>${escapeHtml(corrTxt)}</strong></div>
         ${explain}`;
  }

  function finishQuiz(){
    const lesson = getLessonById(currentLessonId);
    const total = lesson.questions.length;
    const correct = quiz.correctCount;
    const wrong = total - correct;

    const details = lesson.questions.map((q, i)=>{
      const chosen = quiz.answers[i];
      let isCorrect = false;

      if(q.type === "multi"){
        isCorrect = equalSet(normalizeIndices(chosen||[]), normalizeIndices(q.correctIndices||[]));
      }else{
        isCorrect = Number(chosen) === Number(q.correctIndex);
      }

      return {
        qIndex: i,
        type: q.type || "single",
        question: q.text || "",
        chosen,
        correctIndex: q.correctIndex,
        correctIndices: q.correctIndices,
        isCorrect
      };
    });

    const attempt = {
      id: cryptoRandomId(),
      ts: Date.now(),
      lessonId: lesson.id,
      lessonTitle: lesson.title || "Zonder titel",
      total, correct, wrong,
      details
    };

    const history = loadHistory();
    history.unshift(attempt);
    saveHistory(history.slice(0, 500));

    oneQuestion.innerHTML = "";
    submitBtn.style.display = "none";
    nextBtn.style.display = "none";

    const stickerWon = (wrong <= 1);
    const chosenSticker = stickerWon ? pickRandomSticker() : null;

    endScreen.style.display = "";
    endScreen.innerHTML = `
      <div class="center">
        <div class="pill">Resultaat</div>
        <h2 style="margin-top:10px;">Score: ${correct}/${total}</h2>
        <div class="muted">Fouten: ${wrong}</div>
        <div style="height:12px;"></div>

        ${stickerWon ? `
          <div class="center">
            <div class="bigSticker" title="${escapeHtml(chosenSticker.label)}">
              ${chosenSticker.emoji}
            </div>
            <div class="muted" style="margin-top:8px;">
              <strong>Sticker verdiend!</strong> (${escapeHtml(chosenSticker.label)})
            </div>
          </div>
        ` : `
          <div class="muted">Geen sticker deze keer. Probeer opnieuw üí™</div>
        `}

        <div style="height:14px;"></div>
        <button class="primary" id="againBtn" type="button">Nog een keer</button>
      </div>
    `;

    document.getElementById("againBtn").onclick = ()=>{
      resetQuiz();
      renderKid();
    };

    resetQuiz();
  }

  // ===== Parent lock =====
  const parentLockCard = document.getElementById("parentLockCard");
  const parentEditor = document.getElementById("parentEditor");
  const pinSet = document.getElementById("pinSet");
  const pinEnter = document.getElementById("pinEnter");
  const pinMsg = document.getElementById("pinMsg");

  function getPin(){ return localStorage.getItem(PIN_KEY) || ""; }

  function setupParentLock(){
    pinMsg.textContent = "";
    pinSet.value = getPin();
    pinEnter.value = "";
    parentEditor.style.display = "none";
    parentLockCard.style.display = "";
  }

  document.getElementById("savePin").onclick = ()=>{
    const v = (pinSet.value || "").trim();
    if(v && !/^[0-9]{4,8}$/.test(v)){
      pinMsg.textContent = "Gebruik 4 tot 8 cijfers (of laat leeg).";
      return;
    }
    localStorage.setItem(PIN_KEY, v);
    pinMsg.textContent = v ? "Pincode opgeslagen." : "Geen pincode ingesteld.";
  };

  document.getElementById("unlock").onclick = ()=>{
    const saved = getPin();
    const entered = (pinEnter.value || "").trim();
    if(saved && entered !== saved){
      pinMsg.textContent = "Pincode klopt niet.";
      return;
    }
    parentLockCard.style.display = "none";
    parentEditor.style.display = "";
    renderParent();
  };

  // ===== Parent editor =====
  const parentLessonSelect = document.getElementById("parentLessonSelect");
  const editTitle = document.getElementById("editTitle");
  const editText = document.getElementById("editText");
  const editImgUrl = document.getElementById("editImgUrl");
  const editImgCaption = document.getElementById("editImgCaption");
  const questionList = document.getElementById("questionList");

  // question form
  const qTypeEl = document.getElementById("qType");
  const qTextEl = document.getElementById("qText");
  const aEls = ["a0","a1","a2","a3"].map(id => document.getElementById(id));
  const correctSingleEl = document.getElementById("correctSingle");
  const explainSingleEl = document.getElementById("explain");
  const explainMultiEl = document.getElementById("explain2");
  const mChecks = ["m0","m1","m2","m3"].map(id => document.getElementById(id));
  const addQuestionBtn = document.getElementById("addQuestion");
  const cancelEditBtn = document.getElementById("cancelEdit");
  const singleCorrectRow = document.getElementById("singleCorrectRow");
  const multiCorrectRow = document.getElementById("multiCorrectRow");

  function setQuestionTypeUI(){
    const t = qTypeEl.value;
    if(t === "multi"){
      singleCorrectRow.style.display = "none";
      multiCorrectRow.style.display = "";
      addQuestionBtn.textContent = (editingQuestionIndex === null) ? "Vraag toevoegen" : "Vraag bijwerken";
    }else{
      singleCorrectRow.style.display = "";
      multiCorrectRow.style.display = "none";
      addQuestionBtn.textContent = (editingQuestionIndex === null) ? "Vraag toevoegen" : "Vraag bijwerken";
    }
  }
  qTypeEl.onchange = setQuestionTypeUI;

  parentLessonSelect.onchange = (e)=>{
    currentLessonId = e.target.value;
    fillEditor();
    renderQuestionList();
    renderHistory();
    resetQuiz();
    renderKid();
  };

  function renderParent(){
    renderLessonDropdown(parentLessonSelect);
    fillEditor();
    renderQuestionList();
    renderHistoryFilter();
    renderHistory();
  }

  function clearQuestionForm(){
    editingQuestionIndex = null;
    qTypeEl.value = "single";
    qTextEl.value = "";
    aEls.forEach(el=>el.value="");
    correctSingleEl.value = "0";
    explainSingleEl.value = "";
    explainMultiEl.value = "";
    mChecks.forEach(c=>c.checked=false);
    addQuestionBtn.textContent = "Vraag toevoegen";
    cancelEditBtn.style.display = "none";
    setQuestionTypeUI();
  }

  function fillEditor(){
    const lesson = getLessonById(currentLessonId);
    currentLessonId = lesson.id;

    editTitle.value = lesson.title || "";
    editText.value = lesson.text || "";
    editImgUrl.value = lesson.imageUrl || "";
    editImgCaption.value = lesson.imageCaption || "";

    clearQuestionForm();
  }

  cancelEditBtn.onclick = clearQuestionForm;

  document.getElementById("addLesson").onclick = ()=>{
    const newLesson = { id: cryptoRandomId(), title: "Nieuwe tekst", text: "", imageUrl:"", imageCaption:"", questions: [] };
    DB.lessons.unshift(newLesson);
    currentLessonId = newLesson.id;
    saveDB();
    renderParent();
    renderLessonDropdown(lessonSelect);
    resetQuiz();
    renderKid();
  };

  document.getElementById("deleteLesson").onclick = ()=>{
    if(DB.lessons.length <= 1){
      alert("Je moet minstens 1 tekst hebben.");
      return;
    }
    if(!confirm("Weet je zeker dat je deze tekst wilt verwijderen?")) return;
    DB.lessons = DB.lessons.filter(l=>l.id !== currentLessonId);
    currentLessonId = DB.lessons[0].id;
    saveDB();
    renderParent();
    renderLessonDropdown(lessonSelect);
    resetQuiz();
    renderKid();
  };

  document.getElementById("saveLesson").onclick = ()=>{
    const lesson = getLessonById(currentLessonId);
    lesson.title = (editTitle.value || "").trim() || "Zonder titel";
    lesson.text = (editText.value || "").trim();
    lesson.imageUrl = (editImgUrl.value || "").trim();
    lesson.imageCaption = (editImgCaption.value || "").trim();
    saveDB();

    renderLessonDropdown(parentLessonSelect);
    renderLessonDropdown(lessonSelect);
    renderKid();
    alert("Opgeslagen!");
  };

  addQuestionBtn.onclick = ()=>{
    const lesson = getLessonById(currentLessonId);

    const type = qTypeEl.value === "multi" ? "multi" : "single";
    const qt = (qTextEl.value || "").trim();
    const opts = aEls.map(el => (el.value || "").trim());
    if(!qt){ alert("Vul een vraag in."); return; }
    if(opts.some(o=>!o)){ alert("Vul alle 4 antwoordopties in."); return; }

    let payload = { type, text: qt, options: opts };

    if(type === "single"){
      payload.correctIndex = Number(correctSingleEl.value);
      payload.explanation = (explainSingleEl.value || "").trim();
    }else{
      const correctIndices = mChecks.map((c,idx)=> c.checked ? idx : null).filter(v=>v!==null);
      if(correctIndices.length === 0){
        alert("Kies bij multiple choice minstens 1 juiste optie.");
        return;
      }
      payload.correctIndices = normalizeIndices(correctIndices);
      payload.explanation = (explainMultiEl.value || "").trim();
    }

    if(editingQuestionIndex === null){
      lesson.questions.push(payload);
    }else{
      lesson.questions[editingQuestionIndex] = payload;
    }

    saveDB();
    clearQuestionForm();
    renderQuestionList();
    resetQuiz();
    renderKid();
  };

  function renderQuestionList(){
    const lesson = getLessonById(currentLessonId);
    questionList.innerHTML = "";

    if(!lesson.questions || lesson.questions.length === 0){
      questionList.innerHTML = `<div class="muted">Nog geen vragen. Voeg hierboven vragen toe.</div>`;
      return;
    }

    lesson.questions.forEach((q, i)=>{
      const typeTag = q.type === "multi" ? `<span class="tag">multi</span>` : `<span class="tag">single</span>`;
      const correctInfo = q.type === "multi"
        ? `Juiste: ${normalizeIndices(q.correctIndices||[]).map(idxToLetter).join(", ")}`
        : `Juiste: ${idxToLetter(q.correctIndex)}`;

      const div = document.createElement("div");
      div.className = "listItem";
      div.innerHTML = `
        <div class="two">
          <div><strong>${i+1}.</strong> ${escapeHtml(q.text || "").replaceAll("\n","<br>")} &nbsp; ${typeTag}</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
            <button class="ghost" type="button" data-up="${i}" ${i===0 ? "disabled" : ""}>‚ñ≤</button>
            <button class="ghost" type="button" data-down="${i}" ${i===lesson.questions.length-1 ? "disabled" : ""}>‚ñº</button>
            <button class="ghost" type="button" data-edit="${i}">Bewerk</button>
            <button class="danger" type="button" data-del="${i}">Verwijder</button>
          </div>
        </div>
        <div class="muted small" style="margin-top:6px;">
          A: ${escapeHtml((q.options||[])[0]||"")}<br>
          B: ${escapeHtml((q.options||[])[1]||"")}<br>
          C: ${escapeHtml((q.options||[])[2]||"")}<br>
          D: ${escapeHtml((q.options||[])[3]||"")}<br>
          <strong>${escapeHtml(correctInfo)}</strong>
          ${q.explanation ? `<br><strong>Uitleg:</strong> ${escapeHtml(q.explanation)}` : ""}
        </div>
      `;
      questionList.appendChild(div);
    });

    // delete
    questionList.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const idx = Number(btn.getAttribute("data-del"));
        const lesson = getLessonById(currentLessonId);
        lesson.questions.splice(idx, 1);
        saveDB();
        clearQuestionForm();
        renderQuestionList();
        resetQuiz();
        renderKid();
      };
    });

    // edit
    questionList.querySelectorAll("button[data-edit]").forEach(btn=>{
      btn.onclick = ()=>{
        const idx = Number(btn.getAttribute("data-edit"));
        const lesson = getLessonById(currentLessonId);
        const q = lesson.questions[idx];

        editingQuestionIndex = idx;

        qTypeEl.value = q.type === "multi" ? "multi" : "single";
        qTextEl.value = q.text || "";
        aEls[0].value = (q.options||[])[0] || "";
        aEls[1].value = (q.options||[])[1] || "";
        aEls[2].value = (q.options||[])[2] || "";
        aEls[3].value = (q.options||[])[3] || "";

        if(q.type === "multi"){
          mChecks.forEach(c=>c.checked=false);
          normalizeIndices(q.correctIndices||[]).forEach(i=>{ if(mChecks[i]) mChecks[i].checked = true; });
          explainMultiEl.value = q.explanation || "";
          explainSingleEl.value = "";
        }else{
          correctSingleEl.value = String(Number.isFinite(Number(q.correctIndex)) ? Number(q.correctIndex) : 0);
          explainSingleEl.value = q.explanation || "";
          explainMultiEl.value = "";
          mChecks.forEach(c=>c.checked=false);
        }

        addQuestionBtn.textContent = "Vraag bijwerken";
        cancelEditBtn.style.display = "";
        setQuestionTypeUI();

        window.scrollTo({ top: 0, behavior: "smooth" });
      };
    });

    // up
    questionList.querySelectorAll("button[data-up]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-up"));
        const lesson = getLessonById(currentLessonId);
        if(i <= 0) return;
        [lesson.questions[i-1], lesson.questions[i]] = [lesson.questions[i], lesson.questions[i-1]];
        saveDB();
        renderQuestionList();
      };
    });

    // down
    questionList.querySelectorAll("button[data-down]").forEach(btn=>{
      btn.onclick = ()=>{
        const i = Number(btn.getAttribute("data-down"));
        const lesson = getLessonById(currentLessonId);
        if(i >= lesson.questions.length - 1) return;
        [lesson.questions[i+1], lesson.questions[i]] = [lesson.questions[i], lesson.questions[i+1]];
        saveDB();
        renderQuestionList();
      };
    });
  }

  // ===== Import/Export texts =====
  document.getElementById("exportData").onclick = ()=>{
    const dataStr = JSON.stringify(DB, null, 2);
    const blob = new Blob([dataStr], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "begrijpend-lezen-teksten.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  document.getElementById("importData").onclick = async ()=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "application/json";
    inp.onchange = async ()=>{
      const file = inp.files?.[0];
      if(!file) return;
      const txt = await file.text();
      try{
        const parsed = JSON.parse(txt);
        if(!parsed || !Array.isArray(parsed.lessons)) throw new Error();

        parsed.lessons.forEach(l=>{
          l.id = l.id || cryptoRandomId();
          l.title = l.title || "Zonder titel";
          l.text = l.text || "";
          l.imageUrl = l.imageUrl || "";
          l.imageCaption = l.imageCaption || "";
          l.questions = Array.isArray(l.questions) ? l.questions : [];

          // normalize like loadDB
          l.questions.forEach(q=>{
            q.type = q.type === "multi" ? "multi" : "single";
            q.text = q.text || "";
            q.options = Array.isArray(q.options) ? q.options : ["","","",""];
            q.options = [q.options[0]||"", q.options[1]||"", q.options[2]||"", q.options[3]||""];

            if(q.type === "single"){
              q.correctIndex = Number.isFinite(Number(q.correctIndex)) ? Number(q.correctIndex) : 0;
              q.explanation = q.explanation ?? q.explain ?? "";
            }else{
              if(!Array.isArray(q.correctIndices)){
                if(Number.isFinite(Number(q.correctIndex))) q.correctIndices = [Number(q.correctIndex)];
                else q.correctIndices = [];
              }
              q.correctIndices = normalizeIndices(q.correctIndices);
              q.explanation = q.explanation ?? q.explain ?? "";
            }
          });
        });

        DB = parsed;
        currentLessonId = DB.lessons[0]?.id || cryptoRandomId();
        saveDB();
        alert("Import gelukt!");
        renderParent();
        renderLessonDropdown(lessonSelect);
        resetQuiz();
        renderKid();
      }catch{
        alert("Import mislukt: dit bestand is geen geldige export.");
      }
    };
    inp.click();
  };

  // ===== History UI =====
  const historyLessonFilter = document.getElementById("historyLessonFilter");
  const historyLimit = document.getElementById("historyLimit");
  const historyTableWrap = document.getElementById("historyTableWrap");
  const historyDetailsWrap = document.getElementById("historyDetailsWrap");

  function renderHistoryFilter(){
    historyLessonFilter.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "";
    optAll.textContent = "Alle teksten";
    historyLessonFilter.appendChild(optAll);

    DB.lessons.forEach(l=>{
      const opt = document.createElement("option");
      opt.value = l.id;
      opt.textContent = l.title;
      historyLessonFilter.appendChild(opt);
    });
    historyLessonFilter.value = "";
  }

  historyLessonFilter.onchange = ()=> renderHistory();
  historyLimit.onchange = ()=> renderHistory();

  function fmtDate(ts){
    try{ return new Date(ts).toLocaleString(); }catch{ return String(ts); }
  }

  function renderHistory(){
    const filterLesson = historyLessonFilter.value || "";
    const limit = Math.max(1, Math.min(500, Number(historyLimit.value || 50)));

    const history = loadHistory()
      .filter(a => !filterLesson || a.lessonId === filterLesson)
      .slice(0, limit);

    if(history.length === 0){
      historyTableWrap.innerHTML = `<div class="muted">Nog geen resultaten.</div>`;
      historyDetailsWrap.innerHTML = "";
      return;
    }

    historyTableWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Datum/tijd</th>
            <th>Tekst</th>
            <th>Score</th>
            <th>Fouten</th>
          </tr>
        </thead>
        <tbody>
          ${history.map(a=>`
            <tr>
              <td>${escapeHtml(fmtDate(a.ts))}</td>
              <td>${escapeHtml(a.lessonTitle)}</td>
              <td><strong>${a.correct}/${a.total}</strong></td>
              <td>${a.wrong}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    historyDetailsWrap.innerHTML = history.map(a=>{
      const sticker = a.wrong <= 1 ? "‚≠ê sticker" : "‚Äî";
      return `
        <details>
          <summary>${escapeHtml(fmtDate(a.ts))} ‚Ä¢ ${escapeHtml(a.lessonTitle)} ‚Ä¢ ${a.correct}/${a.total} ‚Ä¢ ${sticker}</summary>
          <div class="muted small" style="margin-top:8px;">Details per vraag:</div>
          <ol style="margin:8px 0 0 18px; padding:0;">
            ${(a.details || []).map(d=>{
              const ok = d.isCorrect ? "‚úÖ" : "‚ùå";
              const type = d.type === "multi" ? "multi" : "single";
              let chosen = "-";
              let corr = "-";

              if(type === "multi"){
                chosen = Array.isArray(d.chosen) && d.chosen.length ? d.chosen.map(idxToLetter).join(", ") : "-";
                corr = Array.isArray(d.correctIndices) && d.correctIndices.length ? d.correctIndices.map(idxToLetter).join(", ") : "-";
              }else{
                chosen = (d.chosen === null || d.chosen === undefined) ? "-" : idxToLetter(Number(d.chosen));
                corr = idxToLetter(Number(d.correctIndex));
              }

              return `<li style="margin:8px 0;">
                ${ok} <strong>${escapeHtml(d.question).replaceAll("\n","<br>")}</strong>
                <div class="muted small" style="margin-top:4px;">Type: ${type} ‚Ä¢ Gekozen: <strong>${escapeHtml(chosen)}</strong> ‚Ä¢ Juiste: <strong>${escapeHtml(corr)}</strong></div>
              </li>`;
            }).join("")}
          </ol>
        </details>
      `;
    }).join("");
  }

  document.getElementById("clearHistory").onclick = ()=>{
    if(!confirm("Weet je zeker dat je alle resultaten wilt wissen?")) return;
    saveHistory([]);
    renderHistory();
  };

  document.getElementById("exportHistory").onclick = ()=>{
    const history = loadHistory();
    const dataStr = JSON.stringify(history, null, 2);
    const blob = new Blob([dataStr], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "begrijpend-lezen-resultaten.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  // ===== Image zoom overlay =====
  const zoomOverlay = document.getElementById("zoomOverlay");
  const zoomImg = document.getElementById("zoomImg");
  kidImg.addEventListener("click", ()=>{
    if(!kidImg.src) return;
    zoomImg.src = kidImg.src;
    zoomOverlay.style.display = "flex";
  });
  zoomOverlay.addEventListener("click", ()=>{
    zoomOverlay.style.display = "none";
    zoomImg.removeAttribute("src");
  });

  // ===== Init =====
  // Ensure currentLessonId is valid
  if(!DB.lessons.find(l=>l.id===currentLessonId)) currentLessonId = DB.lessons[0]?.id || currentLessonId;

  // Set initial parent question UI state
  setQuestionTypeUI();

  // Start in kid mode
  setMode("kid");
</script>
</body>
</html>
